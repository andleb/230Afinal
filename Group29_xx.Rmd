---
title: |
  | STAT 230A Final project
  | Replication of Michalopoulos: The Origins of Ethnolinguistic Diversity
author: 
  - Andrej Leban, andrej_leban@berkeley.edu
  - Isaac Schmidt, ischmidt20@berkeley.edu
email: 
  - "andrej_leban@berkeley.edu"
  - "ischmidt20@berkeley.edu"
# date: "`r format(Sys.time(), '%B %d, %Y')`"
header-includes:
  - \usepackage{float, amsthm, amsmath, amssymb, bm, enumitem, latexsym, color, minipage-marginpar, caption, multirow, verbatim, xcolor}
geometry: margin=1in
# linestretch: 1.5
output:
  pdf_document:
    # TODO: enable for the final writeup
    toc: no
    number_sections: true
    df_print: kable
papersize: a4
urlcolor: blue
# bibliography: [references.bib]
editor_options:
  markdown:
    wrap: 120
always_allow_html: true
---

```{r setup, echo = FALSE, message=FALSE, warning=FALSE}
# load in useful packages
library(tidyverse)
library(viridis)

# extra:
library(gsubfn)
library(reshape2)

library(data.table)

library(knitr)
library(kableExtra)
library(ggrastr)

library(readstata13)
library(sf)

def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})


# set default knitr chunks
knitr::opts_chunk$set(
  echo = TRUE,
  fig.align = "center",
  fig.height = 4,
  fig.pos = "H",
  fig.width = 6,
  message = FALSE,
  warning = FALSE,
  cache = F,
  results = 'hide', 
  size="small"
)

# define my_theme - append here
my_theme <- theme_minimal()
```

`r #TODO: margins, font size, group name & name in upper right`

<!-- LaTeX preamble -->
  \newcommand{\E}{{\mathbb E}}
\newcommand{\se}{{\mathcal{E}}}
\newcommand{\R}{{\mathbb R}}
\renewcommand{\P}{{\mathbb P}}
\newcommand{\ac}{{\mathcal{A}}}
\newcommand{\A}{{\mathcal{A}}}
\newcommand{\B}{{\mathcal{B}}}
\newcommand{\T}{{\mathcal{T}}}
\newcommand{\Z}{{\mathcal{Z}}}
\newcommand{\K}{{\mathcal{K}}}
\newcommand{\lc}{{\mathcal{L}}}
\newcommand{\Ps}{{\mathcal{P}}}
\newcommand{\pa}{{\mathring{p}}}
\newcommand{\F}{{\cal F}}
\newcommand{\samp}{{\mathcal{X}}}
\newcommand{\X}{{\mathcal{X}}}
\newcommand{\hi}{{\hat{\Phi}}}

\def\qt#1{\qquad\text{#1}}

\def\argmin{\mathop{\rm argmin}}
\def\argmax{\mathop{\rm argmax}}

\setlength{\parskip}{1.4 \medskipamount}


```{r data_import, echo=F}
cells = read_sf(dsn = 'data_raw/Virtual_country', layer = 'virtual_cntrygrid')
countries = read_sf(dsn = 'countries', layer = 'countries')
data = read.dta13("data_raw/Tables1-3a.dta")
```

```{r rename, echo=F}
colnames(data) = c('countryCode', 'entryYear', 'countryName', 'avgTemp', 
                   'avgPrecip', 'seaDist', 'avgElev', 'sdElev', 'absLat', 
                   'erange_geconclip', 'numLang', 'suitableCells', 'suitRange',
                   'climate', 'soil', 'sdClimate', 'sdSoil', 'sdSuitable', 
                   'avgSuitable', 'pop95', 'area', 'lnLang', 'africa', 
                   'europe', 'americas', 'lnPop95', 'migrationDist', 
                   'lnArea', 'pctIndigenous', 'lnPopDens1500', 
                   'agriTran', 'reg_eap')
```

# Paper summary & summary statistics table

## Paper summary

The paper by Michalopoulos aims to explain ethnolinguistic diversity within and across countries by assuming that a proxy quantity
- the number of languages per square kilometer - is determined by a selection of various economic, historical, and 
geographic variables. It determines that *variation in regional land quality* and *variation in elevation* are 
the most significant determinants of linguistic diversity. The hypothesis underpinning this examination is that differences
in local land characteristics induce different levels of human capital across locations, which in turn, gives rise to localized 
ethnicities that are characterized by separate languages. The results of the empirical study presented are found to 
be consistent with this hypothesis.

The empirical results are obtained separately by three regressions:  

* **Cross-country**: this takes the current political borders as the unit within which covariates such as the number 
  of languages are counted.

* **Virtual countries**: To account for the arbitrary nature of some political boundaries with respect to ethnolinguistic
  groupings, the world is split into arbitrary *virtual countries* and the regression is performed again.
  
* **Adjacent regions**: To account for a potentially high "baseline" effect in some regions, adjacent regions are
  compared directly, which neutralizes region-specific fixed effects and focuses on the effect of the variables under consideration.
  
<!-- Finally, in regions that have undergone a major demographic shift in the last 500 years, the explanatory power of the model -->
<!-- is found to be significantly weaker; these regions are controlled for with a dummy variable. -->

## Data statistics and summary table

The data comes from multiple sources: the standard geographic data was sourced from the *Geographically Based Economic Data database*,
the data on land quality for agriculture comes from *Ramankutty et al. (2002)*, and the data on the distribution of 
languages comes from the *World Language Mapping System*. Fortunately, the data provided by the author was already processed
and cleaned to the extent used in the paper. All we did was rename columns to more descriptive names.

The paper lacks a true summary table and shows a couple of EDA figures instead. We replicate two of those figures,
and then display our own summary table of the features used in the paper's first regression - the *cross-country model*.
Figure \ref{fig:suit} shows the distribution of land suitability for agriculture across the world at a resolution of .5-by.5 decimal degrees. 
The dependent variable represents the probability that a particular grid cell may be cultivated. 

```{r fig1, fig.cap="\\label{fig:suit} Land quality for agriculture across countries", echo=F, cache=T, fig.width = 6, fig.height=4}
fig1 = ggplot(cells) + rasterize(geom_sf(aes(fill = suit_new), colour = NA), dpi=450) +
  scale_fill_viridis_c("Land quality", direction = -1 ) + my_theme
fig1
```

```{r greeceNepal, cache=TRUE, echo=F}
greeceCells = countries %>% filter(COUNTRY == 'Greece') %>%
  st_intersection(y = cells)
nepalCells = countries %>% filter(COUNTRY == 'Nepal') %>%
  st_intersection(y = cells)
```

Figure \ref{fig:kde1} shows the distribution of land quality within two countries selected in the paperâ€”Greece and Nepal, 
obtained with a KDE using the Epanechnikov kernel.

```{r worldMap, fig.cap="\\label{fig:kde1} Kernel Density of Land Quality in Greece and Nepal", echo=F, fig.width = 5, fig.height=3}
plot(
  density(greeceCells$suit_new, kernel = "epanechnikov"),
  xlim = c(0, 1),
  xlab = 'Land quality per region',
  ylab = 'Density',
  main = '',
  lty = 2
)
lines(density(nepalCells$suit_new, kernel = "epanechnikov"), col = 'red')
legend(
  .1,
  3,
  legend = c(
    'Distribution of land quality in Greece',
    'Distribution of land quality in Nepal'
  ),
  col = c("black", "red"),
  lty = 2:1,
  cex = .75
)
```

Below is our summary table of important variables for the first model. The dependent variable is `numLang`, which is the number of languages whose "traditional homeland" intersects with the country's boundary. Other variables, such as `avgSuitable` and `sdSuitable`, were aggregated from the land suitability dataset described above. 
Additional covariates are measures of centrality and variablity, the log of the country's 1995 population, human migration distance from Africa, and distance from a large body of water. While some other variables in the provided dataset have missing values for some countries, note that all variables included in the first regression are known for all countries.

```{r summary, results='hide', echo=F}
count = function(x) {
  (sum( ~ is.na(x)))
}

sumTable <- data %>% select(
  c(
    'numLang',
    'sdElev',
    'sdSuitable',
    'avgElev',
    'avgSuitable',
    'absLat',
    'avgPrecip',
    'avgTemp',
    'lnArea',
    'seaDist',
    'migrationDist',
    'lnPop95'
  )
) %>%
  summarise_each(
    funs(
      min = min,
      median = median,
      max = max,
      mean = mean,
      iqr = quantile(., 0.75) - quantile(., 0.25),
      sd = sd,
      n = sum(!is.na(.))
    )
  ) %>%
  gather(var, val) %>%
  separate(var, into = c("var", "stat"), sep = "_") %>%
  spread(var, val) %>% column_to_rownames(var = "stat") %>%
  select(
    c(
      'numLang',
      'sdElev',
      'sdSuitable',
      'avgElev',
      'avgSuitable',
      'absLat',
      'avgPrecip',
      'avgTemp',
      'lnArea',
      'seaDist',
      'migrationDist',
      'lnPop95'
    )
  ) %>%
  mutate_if(is.numeric, ~ round(., 2)) %>% slice(5, 4, 2, 3, 7, 6)
```
```{r summaryPrint, results='show', echo=F}
knitr::kable(sumTable[, 1:6])
knitr::kable(sumTable[, 7:ncol(sumTable)])
```


# Model 1

## Replication

```{r standardize, echo=F}
standardize = function(vec) {return ((vec - mean(vec, na.rm = TRUE)) / sd(vec, na.rm = TRUE))}

modelCols = c('entryYear', 'avgTemp', 'avgPrecip', 'seaDist', 'avgElev', 
              'sdElev', 'absLat', 'numLang', 'suitRange', 'climate', 
              'soil', 'sdClimate', 'sdSoil', 'sdSuitable', 'avgSuitable', 
              'pop95', 'area', 'lnLang', 'lnPop95', 'migrationDist', 
              'lnArea', 'pctIndigenous', 'lnPopDens1500', 'agriTran',
              'americas', 'europe', 'africa', 'reg_eap')

for (col in modelCols) {
  data[,col] = standardize(data[,col])
}
```

```{r, echo=F}
model1 = lm(lnLang ~ absLat, data)
summary(model1)
```

```{r model2, echo=F}
model2 = lm(lnLang ~ sdElev + sdSuitable + avgElev + avgSuitable + absLat, data)
summary(model2)
```

```{r, echo=F}
model3 = lm(lnLang ~ sdElev + sdSuitable + avgElev + avgSuitable + absLat
            + avgPrecip + avgTemp + lnArea + seaDist + migrationDist, data)
summary(model3)
```

```{r, echo=F}
model4 = lm(lnLang ~ sdElev + sdSuitable + avgElev + avgSuitable + absLat
            + avgPrecip + avgTemp + lnArea + seaDist + migrationDist + lnPop95
            + africa + europe + americas + reg_eap, data)
summary(model4)
```

```{r, echo=F}
missingData = is.na(data$agriTran) | is.na(data$entryYear) | is.na(data$lnPopDens1500)
for (col in modelCols) {
  data[!missingData,col] = standardize(data[!missingData,col])
}

model5 = lm(lnLang ~ sdElev + sdSuitable + avgElev + avgSuitable + absLat
            + avgPrecip + avgTemp + lnArea + seaDist + migrationDist + lnPop95
            + lnPopDens1500 + entryYear + agriTran
            + africa + europe + americas + reg_eap, data, na.action = na.exclude)
summary(model5)

```


## Robustness check 

```{r model1Robustness, results='hide', echo=F}


```


<!-- # "Re-analysis" -->

\newpage
# Appendix: code
<!-- NOTE: add code chunks to be displayed here -->
```{r codeAppendix, ref.label=c('data_import', 'rename', 'greeceNepal', 'worldMap', 'summary', 'standardize', 'model2'), echo=T, eval=F}

```








